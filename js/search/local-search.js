window.addEventListener("load",(()=>{let t=!1,e=[];const a=document.getElementById("search-mask"),s=()=>{const e=document.body.style;e.width="100%",e.overflow="hidden",btfanimateIn(a,"to_show 0.5s"),btfanimateIn(document.querySelector("#local-search .search-dialog"),"titleScale 0.5s"),setTimeout((()=>{document.querySelector("#local-search-input input").focus()}),100),t||(n(),t=!0),document.addEventListener("keydown",(function t(e){"Escape"===e.code&&(c(),document.removeEventListener("keydown",t))}))},c=()=>{const t=document.body.style;t.width="",t.overflow="",btfanimateOut(document.querySelector("#local-search .search-dialog"),"search_close .5s"),btfanimateOut(a,"to_hide 0.5s")},l=()=>{document.querySelector("#search-button > .search").addEventListener("click",s),document.querySelector("#menu-search").addEventListener("click",s)},i=async t=>{let e=[];const a=await fetch(t);if(/\.json$/.test(t))e=await a.json();else{const t=await a.text(),s=await(new window.DOMParser).parseFromString(t,"text/xml");e=[...(await s).querySelectorAll("entry")].map((t=>{let e=[];t.querySelector("tags")&&t.querySelector("tags").getElementsByTagName("tag")&&Array.prototype.forEach.call(t.querySelector("tags").getElementsByTagName("tag"),(function(t,a){e.push(t.textContent)}));let a=t.querySelector("content")&&t.querySelector("content").textContent,s=/src=[\'\"]?([^\'\"]*)[\'\"]?/i,c=a.match(/<img.*?(?:>|\/>)/gi),l=[];if(c)for(let t=0;t<c.length;t++){let e=c[t].match(s);e[1].indexOf("http")||l.push(e[1])}return{title:t.querySelector("title").textContent,content:a,url:t.querySelector("url").textContent,tags:e,oneImage:l&&l[0]}}))}if(a.ok){const t=document.getElementById("loading-database");t.nextElementSibling.style.display="block",t.remove()}return e},n=()=>{GLOBAL_CONFIG.localSearch.preload||(e=i(GLOBAL_CONFIG.localSearch.path));const t=document.querySelector("#local-search-input input"),a=document.getElementById("local-search-results"),s=document.getElementById("loading-status");t.addEventListener("input",(function(){const t=this.value.trim().toLowerCase().split(/[\s]+/);""!==t[0]&&(s.innerHTML='<i class="fas fa-spinner fa-pulse"></i>'),a.innerHTML="";let c='<div class="search-result-list">';if(t.length<=0)return;let l=0;e.then((e=>{e.forEach((e=>{let a=!0,s=e.title?e.title.trim().toLowerCase():"",i=e.tags,n=e.oneImage??"";const o=e.content?e.content.trim().replace(/<[^>]+>/g,"").toLowerCase():"",r=e.url.startsWith("/")?e.url:GLOBAL_CONFIG.root+e.url;let d=-1,h=-1,u=-1;if(""!==s||""!==o?t.forEach(((t,e)=>{d=s.indexOf(t),h=o.indexOf(t),d<0&&h<0?a=!1:(h<0&&(h=0),0===e&&(u=h))})):a=!1,a){if(u>=0){let e=u-30,a=u+100,d="",h="";e<0&&(e=0),0===e?a=100:d="...",a>o.length?a=o.length:h="...";let m=o.substring(e,a);if(t.forEach((t=>{const e=RegExp(t,"gi");m=m.replace(e,'<span class="search-keyword">'+t+"</span>"),s=s.replace(e,'<span class="search-keyword">'+t+"</span>")})),c+='<div class="local-search__hit-item">',c+=n?`<div class="search-left"><img src=${n} alt=${s} data-fancybox='gallery'>`:'<div class="search-left" style="width:0">',c+="</div>",c+=n?'<div class="search-right"><a href="'+r+'" class="search-result-title">'+s+"</a>":'<div class="search-right" style="width: 100%"><a href="'+r+'" class="search-result-title">'+s+"</a>",l+=1,""!==o&&(c+='<p class="search-result" onclick="pjax.loadUrl(`'+r+'`)">'+d+m+h+"</p>"),i.length){c+='<div class="search-result-tags">';for(let t=0;t<i.length;t++){const e=i[t].trim();c+='<a class="tag-list" href="/tags/'+e+'/" data-pjax-state="" one-link-mark="yes">#'+e+"</a>"}c+="</div>"}}c+="</div></div>"}})),0===l&&(c+='<div id="local-search__hits-empty">'+GLOBAL_CONFIG.localSearch.languages.hits_empty.replace(/\$\{query}/,this.value.trim())+"</div>"),c+="</div>",a.innerHTML=c,""!==t[0]&&(s.innerHTML=""),window.pjax&&window.pjax.refresh(a)}))}))};l(),document.querySelector("#local-search .search-close-button").addEventListener("click",c),a.addEventListener("click",c),GLOBAL_CONFIG.localSearch.preload&&(e=i(GLOBAL_CONFIG.localSearch.path)),window.addEventListener("pjax:complete",(()=>{!btfisHidden(a)&&c(),l()}))}));